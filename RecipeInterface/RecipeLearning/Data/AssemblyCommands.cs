using System.Data.SqlClient;

namespace RecipeLearning.Data;

internal static class AssemblyCommands
{
    private const string createAssemblyCommand = @"
DECLARE @clrName nvarchar(4000) = 'databasefunctions, version=1.0.0.0, culture=neutral, publickeytoken=195628861950b8dd, processorarchitecture=msil'
DECLARE @asmBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103009F36B8BB0000000000000000E00022200B013000001200000006000000000000623100000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000000000000300608500001000001000000000100000100000000000001000000000000000000000000D3100004F00000000400000B803000000000000000000000000000000000000006000000C00000044300000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000068110000002000000012000000020000000000000000000000000000200000602E72737263000000B8030000004000000004000000140000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000180000000000000000000000000000400000420000000000000000000000000000000041310000000000004800000002000500AC230000980C000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001E0228030000062A1E02281000000A2A8A0228070000061000022806000006100002280500000610000228040000061000022A467E010000040272010000706F1100000A2A0000001B30040066000000010000117E020000046F1200000A0A2B43066F1300000A0B02077215000070281400000A077219000070281400000A6F1500000A10000207721D000070281400000A077223000070281400000A6F1500000A1000066F1600000A2DB5DE0A062C06066F1700000ADC022A00000110000002000B004F5A000A00000000E27E030000040272290000706F1100000A10007E0400000402723B0000706F1100000A10007E0500000402724F0000706F1100000A1000022A0000001B3003003E000000020000117E060000046F1800000A0A2B1B066F1900000A0B02077B1A00000A077B1B00000A6F1500000A1000066F1600000A2DDDDE0A062C06066F1700000ADC022A00000110000002000B002732000A0000000013300500E901000000000000726D000070731C00000A80010000041D8D1700000125167291000070A225177299000070A2251872AF000070A2251972C1000070A2251A72CD000070A2251B72D9000070A2251C72E5000070A2280100002B800200000472EF00007017731E00000A800300000472FD00007017731E00000A8004000004720D01007017731E00000A80050000041F0F8D0500001B2516721D0100707221010070731F00000AA40500001B2517722B010070722F010070731F00000AA40500001B25187239010070723D010070731F00000AA40500001B25197247010070724B010070731F00000AA40500001B251A72550100707259010070731F00000AA40500001B251B72630100707267010070731F00000AA40500001B251C72710100707275010070731F00000AA40500001B251D727F0100707283010070731F00000AA40500001B251E728D0100707291010070731F00000AA40500001B251F09729B010070729F010070731F00000AA40500001B251F0A72A901007072AD010070731F00000AA40500001B251F0B72B701007072BB010070731F00000AA40500001B251F0C72C501007072C9010070731F00000AA40500001B251F0D72D301007072D7010070731F00000AA40500001B251F0E72E101007072E5010070731F00000AA40500001B280200002B80060000042A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000058030000237E0000C40300007004000023537472696E67730000000034080000F001000023555300240A0000100000002347554944000000340A00006402000023426C6F620000000000000002000001571502080908000000FA013300160000010000001B000000030000000600000008000000060000001F0000000F0000000200000005000000010000000300000002000000000061020100000000000600900138030600FD0138030600AF0006030F00580300000600D700830206007301830206003F0183020600E40183020600B00183020600C90183020600EE0083020600C30019030600A1001903060022018302060009012102060032047C020A005E01C4020A007600C4020E005804670306000100420206002A007C02060016005B0006003B027C020600DF02D90306008D007C0206005E047C020E00FE036703000000003D00000000000100010001001000F403EC0341000100010080011000B202EC034100010003003100C003B70031001D04BB003100A802B70031009D02B70031009502B7003100CF03C20050200000000096004E04CE0001005820000000008618F9020600020060200000000093004E04CE0002008320000000009100B103CE00030098200000000091000B04CE0004001C210000000091008603CE00050058210000000091009A03CE000600B421000000009118FF02D3000700000001007702000001001B02000001001B02000001001B02000001001B02000001001B020900F90201001100F90206001900F9020A002900F90210003100F90210003900F90210004100F90210004900F90210005100F90210005900F90210006100F90215006900F90210007100F90210007900F90210008900F90206008100F9020600990085001A000C00EB022F00140039043E00B9002B044300B90085001A00C10045044900C900990006001C00EB022F00240039043E002C0024007D002C00370081009900F9021000D100640485009900F90296002C00F9029D0020007B00BE012E000B00D7002E001300E0002E001B00FF002E00230008012E002B001F012E0033001F012E003B001F012E00430008012E004B0025012E0053001F012E005B001F012E0063003D012E006B0067012E007300740120004D002900380060006B007600048000000100000000000000000000000000EC030000040000000000000000000000AE00520000000000040000000000000000000000AE00460000000000040000000000000000000000AE007C02000000003B0092003B00A500000000526561644F6E6C79436F6C6C656374696F6E60310049456E756D657261746F726031004974656D310056616C75655475706C656032004974656D32003C4D6F64756C653E0053797374656D2E44617461006D73636F726C69620053797374656D2E436F6C6C656374696F6E732E47656E6572696300446174614163636573734B696E64005265706C6163650049446973706F7361626C6500446973706F736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650076616C75650053797374656D2E52756E74696D652E56657273696F6E696E6700537472696E670053797374656D2E436F6C6C656374696F6E732E4F626A6563744D6F64656C00446174616261736546756E6374696F6E732E646C6C006974656D0053797374656D0053797374656D2E5265666C656374696F6E006D696C41626272006F756E63657341626272006772616D734162627200496E6772656469656E74436C65616E6572004D6963726F736F66742E53716C5365727665722E5365727665720049456E756D657261746F7200476574456E756D657261746F72002E63746F72002E6363746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E546578742E526567756C617245787072657373696F6E730052656D6F7665416262726576696174696F6E730052656D6F7665556E69636F64654672616374696F6E7300436C756D704672616374696F6E7300636C756D704672616374696F6E73006672616374696F6E730053797374656D2E436F6C6C656374696F6E7300446174616261736546756E6374696F6E730052656765784F7074696F6E730052656D6F7665446F75626C65556E69747300616D65726963616E556E69747300436F6E636174004F626A656374006765745F43757272656E74004D6F76654E65787400436C65616E54657874005265676578004172726179004173526561644F6E6C79000000132400310024002400240032002F002400330000032F0000032000000573002F0000057300200000112400310020006700720061006D00730000132400310020006F0075006E00630065007300001D2400310020006D0069006C006C0069006C0069007400650072007300002328005C0064002B0029005C0073002B0028005C00640029002F0028005C0064002900000763007500700000157400610062006C006500730070006F006F006E000011740065006100730070006F006F006E00000B70006F0075006E006400000B6F0075006E0063006500000B710075006100720074000009700069006E007400000D28005C0064002B0029006700000F28005C0064002B0029006F007A00000F28005C0064002B0029006D006C0000035B210109200031002F00380000035C210109200033002F00380000035D210109200035002F00380000035E210109200037002F003800000359210109200031002F00360000035A210109200035002F003600000355210109200031002F003500000356210109200032002F003500000357210109200033002F003500000358210109200034002F0035000003BC000109200031002F0034000003BE000109200033002F003400000353210109200031002F003300000354210109200032002F0033000003BD000109200031002F0032000000DFC5879C1F6DA649B7B141CF63D20C4000042001010803200001052001011111042001010E04200101020520020E0E0E080702151259010E0E05151251010E08200015125901130005151259010E04200013000500020E0E0E0320000212070215125901151155020E0E151155020E0E0A15125101151155020E0E0A15125901151155020E0E06151155020E0E03061300030613010C100101151251011E001D1E00030A010E062002010E116D0720020113001301080A01151155020E0E08B77A5C561934E0890306124D0606151251010E0B0615125101151155020E0E0400010E0E030000010801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730108010002000000000016010011446174616261736546756E6374696F6E73000005010000000017010012436F7079726967687420C2A920203230323200002901002465643835376331372D333736662D343231332D386634312D37306432333638663462616300000C010007312E302E302E3000004901001A2E4E45544672616D65776F726B2C56657273696F6E3D76342E380100540E144672616D65776F726B446973706C61794E616D65122E4E4554204672616D65776F726B20342E3880A2010002005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D342E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E6973746963010000000000004B0D9AA90000000002000000910000007C3000007C1200000000000000000000000000001000000000000000000000000000000052534453D424AA61FC6574488904810A42D40AE901000000433A5C55736572735C4D6174746865774F726D736F6E5C736F757263655C7265706F735C656C736C7573685C43617073746F6E655C526563697065496E746572666163655C446174616261736546756E6374696F6E735C6F626A5C52656C656173655C446174616261736546756E6374696F6E732E706462003531000000000000000000004F31000000200000000000000000000000000000000000000000000041310000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C03000000000000000000005C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC020000010053007400720069006E006700460069006C00650049006E0066006F0000009802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D00650000000000000000004C0012000100460069006C0065004400650073006300720069007000740069006F006E000000000044006100740061006200610073006500460075006E006300740069006F006E0073000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004C001600010049006E007400650072006E0061006C004E0061006D006500000044006100740061006200610073006500460075006E006300740069006F006E0073002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200320000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000044006100740061006200610073006500460075006E006300740069006F006E0073002E0064006C006C000000440012000100500072006F0064007500630074004E0061006D0065000000000044006100740061006200610073006500460075006E006300740069006F006E0073000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000643100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
DECLARE @hash varbinary(64);

SELECT @hash = HASHBYTES('SHA2_512', @asmBin);

IF EXISTS(SELECT 1 FROM sys.trusted_assemblies WHERE hash = @hash AND description = @clrName)
	EXEC sys.sp_drop_trusted_assembly @hash = @hash

EXEC sys.sp_add_trusted_assembly @hash = @hash,
                                 @description = @clrName;

IF OBJECT_ID('DataCollection.CleanText') IS NOT NULL
  DROP FUNCTION DataCollection.CleanText;

IF EXISTS(SELECT 1 FROM sys.assemblies WHERE name = 'DatabaseFunctions')
	DROP ASSEMBLY DatabaseFunctions;

CREATE ASSEMBLY DatabaseFunctions 
FROM @asmBin
WITH PERMISSION_SET = UNSAFE;
",
    createFunctionCommand = @"
CREATE FUNCTION DataCollection.CleanText(@item nvarchar(MAX)) RETURNS nvarchar(MAX) 
AS EXTERNAL NAME DatabaseFunctions.[DatabaseFunctions.Functions].CleanText;   
";

    public static async Task CreateAssembly(string? sqlConnectionString, CancellationToken token = default)
    {
        using SqlConnection sqlConnection = new(sqlConnectionString);
        await sqlConnection.OpenAsync(token);

        using SqlCommand createAssembly = new(createAssemblyCommand, sqlConnection);
        using SqlCommand createFunction = new(createFunctionCommand, sqlConnection);

        await createAssembly.ExecuteNonQueryAsync(token);
        await createFunction.ExecuteNonQueryAsync(token);
    }
}
